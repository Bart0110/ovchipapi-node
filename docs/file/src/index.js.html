<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/index.js | ovchip-api</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="OV Chipkaart API"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="ovchip-api"><meta property="twitter:description" content="OV Chipkaart API"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/OVChip/ovchipapi-node.git"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  </ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/index.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">const asyncq = require(&quot;async-q&quot;);
const Q = require(&quot;q&quot;);
const requestPromise = require(&quot;request-promise&quot;);
const x = require(&quot;./throw-if-missing&quot;)


const normalizeTime = (t) =&gt; new Date((t / 1000 | 0) * 1000);
const normalizeRecordTime = (data) =&gt; Object.assign(data, {
	transactionDateTime: normalizeTime(data.transactionDateTime)
});

/**
 * This library can be used to access basic data from the OV-chipcard network in the Netherlands. &lt;br&gt;
 * Author: Bart0110.
 * @class
 * @alias OVApi
 */
class OVApi {

	/** Creates an instance of OVApi.
	 * @param {String} username - Username used to access ov-chipkaart.nl. This field is required.
	 * @param {String} password - Password used to access ov-chipkaart.nl. This field is required.
	 * @param {String} [clientId=nmOIiEJO5khvtLBK9xad3UkkS8Ua] - Special client identifier used to access ov-chipkaart.nl.
	 * @param {String} [clientSecret=FE8ef6bVBiyN0NeyUJ5VOWdelvQa] - Special client secret bound to the client identifier.
	 */
	constructor(username = x(&apos;Username&apos;), password = x(&apos;Password&apos;), clientId = &apos;nmOIiEJO5khvtLBK9xad3UkkS8Ua&apos;, clientSecret = &apos;FE8ef6bVBiyN0NeyUJ5VOWdelvQa&apos;) {
		/**
		 * The client identifier.
		 * @type {String}
		 * @private
		 */
		this._clientId = clientId;

		/**
		 * The client secret.
		 * @type {String}
		 * @private
		 */
		this._clientSecret = clientSecret;

		/**
		 * The username.
		 * @type {String}
		 * @private
		 */
		this._username = username;

		/**
		 * The password.
		 * @type {String}
		 * @private
		 */
		this._password = password;

		/**
		 * Token from logging into ov-chipkaart.nl. Note: this token is not authorized to do actions like fetching transactions.
		 * @type {(String|null)}
		 * @private
		 */
		this._loginToken = null;

		/**
		 * The refresh token is used to refresh the &apos;main&apos; token for accesing ov-chipkaart.nl.
		 * @type {(String|null)}
		 * @private
		 */
		this._refreshToken = null;

		/**
		 * This token is authorized with the login token. This token is used to perform actions like fetching transactions.
		 * @type {(String|null)}
		 * @private
		 * @see {@link _loginToken}
		 */
		this._dataToken = null;

		/**
		 * As of now it does nothing. This is reserverd in case we need to use it.
		 * @type {(String|null)}
		 * @private
		 */
		this._accessToken = null;

		/**
		 * At the moment the date the login token will expire.
		 * @type {(Date|null)}
		 * @private
		 */
		this._expireDate = null;

		/**
		 * This object holds all the attached cards to the account.
		 * @type {(JSON|null)}
		 * @private
		 */
		this._cards = null;

		/**
		 * Endpoint used to get an access token.
		 * @type {String}
		 * @private
		 */
		this._loginEndpoint = &apos;https://login.ov-chipkaart.nl/oauth2/token&apos;;

		/**
		 * Endpoint used to perform certain actions.
		 * @type {String}
		 * @private
		 */
		this._actionEndpoint = &apos;https://api2.ov-chipkaart.nl/femobilegateway/v1&apos;;

		return this;
	}

	/**
	 * Make a request to the oauth url
	 * @param {Object} form - Parameters to pass to the url.
	 * @return {Promise} - Resolve returns token used to create data token. Reject contains an error message that occurred.
	 * @memberOf OVApi
	 * @private
	 */
	_oAuthRequest(form) {
		return requestPromise({
			method: &apos;POST&apos;,
			uri: this._loginEndpoint,
			form,
		}).then(body =&gt; {
			body = JSON.parse(body);

			this._loginToken = body[&apos;id_token&apos;];
			this._refreshToken = body[&apos;refresh_token&apos;];
			this._accessToken = body[&apos;access_token&apos;];
			this._expireDate = new Date(Date.now() + (body[&apos;expires_in&apos;] * 1000));
			return this._loginToken;
		}).catch(error =&gt; {
			throw ({
				message: &apos;TLS oAuth returned error code &apos; + error[&apos;statusCode&apos;],
				responseCode: error[&apos;statusCode&apos;],
				error: JSON.parse(error[&apos;response&apos;][&apos;body&apos;])
			});
		});
	}


	/**
	 * Login into ov-chipkaart.nl.
	 * @return {Promise} - Resolve returns token used to create data token. Reject returns an error message that occurred while logging in.
	 * @memberOf OVApi
	 * @private
	 */
	_login() {
		if (new Date() &lt; this._expireDate &amp;&amp; this._loginToken != null)
			return Promise.resolve(this._loginToken);

		return this._oAuthRequest({
			client_id: this._clientId,
			client_secret: this._clientSecret,
			username: this._username,
			password: this._password,
			grant_type: &apos;password&apos;,
			scope: &apos;openid&apos;
		});
	}

	/**
	 * Create data token. This method automatically logs you in if you haven&apos;t called _login()
	 * @return {Promise} - Resolve returns token used to access data. Reject returns an error message that occurred while fetching the token.
	 * @memberOf OVApi
	 * @see {@link _login}
	 */
	authorize() {
		return this._login().then((authenticationToken) =&gt; {
			return this._tlsRequest(&apos;api/authorize&apos;, {authenticationToken});
		}).then(token =&gt; {
			this._dataToken = token;
			return token;
		});
	}

	/**
	 * Check if token is expired, if so the function re-authorize the tokens.
	 * @return {Promise} - Resolve returns token used to access data. Reject returns an error message that occurred while fetching the token.
	 * @memberOf OVApi
	 * @private
	 * @see {@link authorize}
	 */
	_checkToken() {
		if (new Date() &lt; this._expireDate &amp;&amp; this._dataToken != null)
			return Promise.resolve(this._dataToken);

		if (this._refreshToken != null) {
			return this._oAuthRequest({
				client_id: this._clientId,
				client_secret: this._clientSecret,
				refresh_token: this._refreshToken,
				grant_type: &apos;refresh_token&apos;
			}).then((authenticationToken) =&gt; {
				return this._tlsRequest(&apos;api/authorize&apos;, { authenticationToken });
			}).then(token =&gt; {
				this._dataToken = token;
				return token;
			});
		} else {
			return this.authorize();
		}
	}

	/**
	 * Make a request to the tls API
	 * @param {String} endpoint - API endpoint to call. This field is required.
	 * @param {Object} [form={}] - Parameters to submit.
	 * @return {Promise} - Resolve returns api response. Reject contains an error message if the API returned a failure or the API request failed.
	 * @memberOf OVApi
	 * @private
	 */
	_tlsRequest(endpoint = x(&apos;Endpoint&apos;), form = {}) {
		return requestPromise({
			method: &apos;POST&apos;,
			uri: `${this._actionEndpoint}/${endpoint}`,
			form: Object.assign({
				authorizationToken: this._dataToken,
			}, form)
		}).then(body =&gt; {
			const {c, o, e} = JSON.parse(body);
			if (c !== 200)
				throw ({
					message: &apos;TLS returned error code &apos; + c,
					responseCode: c,
					error: e
				});

			return o;
		});
	}

	/**
	 * Get all attached cards to the account.
	 * @return {Promise} - Resolve returns all cards attached to the account. Reject returns an error message that occurred while fetching the cards.
	 * @memberOf OVApi
	 */
	getCards() {
		return this._checkToken().then(() =&gt; {
			return this._tlsRequest(&apos;cards/list&apos;)
		});
	}


	/**
	 * Get transactions with optional parameters.
	 * @param {Number} mediumId - Unique card id. You can pull this from getCards(). This field is required.
	 * @param {Object} nrc={} the &apos;nextRequestContext&apos; used to get more data.
	 * @return {Promise} - Resolve returns transactions. Reject returns an error message that occurred while fetching the transactions.
	 * @memberOf OVApi
	 * @see {@link getCards}
	 */
	getTransactionsNRC(mediumId = x(&apos;MediumId&apos;), nrc = {}) {
		return this._checkToken().then(() =&gt; {
			return this._tlsRequest(&apos;transactions&apos;, Object.assign({mediumId}, nrc))
				.then(o =&gt; Object.assign(o, {
					records: o.records.map(normalizeRecordTime),
					continuation: () =&gt; this.getTransactionsNRC(mediumId, o[&apos;nextRequestContext&apos;])
				}));
		});
	}

	/**
	 * Get transactions between two dates.
	 * @param {Number} mediumId - Unique card id. You can pull this from getCards(). This field is required.
	 * @param {String} [startDate=current_date] - The date were the server should start looking. Correct syntax = `YYYY-MM-DD`.
	 * @param {String} [endDate=current_date] - The date were the server should stop looking. Correct syntax = `YYYY-MM-DD`.
	 * @param {Number} [offset=0] - How many records the server should skip.
	 * @return {Promise} - Resolve returns transactions. Reject returns an error message that occurred while fetching the transactions.
	 * @memberOf OVApi
	 * @see {@link getCards}
	 */
	getTransactions(mediumId = x(&apos;MediumId&apos;), startDate = (new Date().toISOString().slice(0, 10)),
					endDate = (new Date().toISOString().slice(0, 10)), offset = 0) {
		return this._checkToken().then(() =&gt; {
			return this.getTransactionsNRC(mediumId, {offset, startDate, endDate});
		});
	}

	/**
	 * Get all the transactions for the specified year. When you don&apos;t specify the year it returns all the records from last year.
	 * @param {Number} mediumId - Unique card id. You can pull this from getCards(). This field is required.
	 * @param {Number|String} [year=last_year] - What year should we look into.
	 * @param {Number} [delay=1000] - The delay between requests in milliseconds.
	 * @return {Promise} - Resolve returns records from the specified year. Reject returns an error message that occurred while fetching the transactions.
	 * @memberOf OVApi
	 * @see {@link getCards}
	 */
	getTransactionsYear(mediumId = x(&apos;MediumId&apos;), year = (new Date().toISOString().split(&quot;-&quot;)[0]) - 1, delay = 1000) {
		let results = [];
		let count = 0;

		return this._checkToken().then(() =&gt; {
			return this.getTransactionsNRC(mediumId, {offset: 0, startDate: `${year}-01-01`, endDate: `${year}-12-31`})
		}).then(transactions =&gt; {
			results = results.concat(transactions[&apos;records&apos;]);
			return asyncq.whilst(() =&gt; {
				return count &lt; Math.floor(transactions[&apos;totalSize&apos;] / 20) * 20;
			}, () =&gt; {
				count += 20;
				return this.getTransactionsNRC(mediumId, {offset: count, startDate: `${year}-01-01`, endDate: `${year}-12-31`}).then(transactionsIteratee =&gt; {
					results = results.concat(transactionsIteratee[&apos;records&apos;]);
					return Q.delay(delay);
				});
			}).then(() =&gt; {
				return results;
			});
		});
	}

	/**
	 * Get detailed card info such as balance, when the balance was last updated, auto reload information (automatic balance upgrade)
	 * and the date when the card expires.
	 * @param {Number} mediumId - Unique card id. You can pull this from getCards(). This field is required.
	 * @return {Promise} - Resolve returns detailed information about the card. Reject returns an error message that occurred while fetching the transactions.
	 * @memberOf OVApi
	 * @see {@link getCards}
	 */
	getDetailedCardInfo(mediumId = x(&apos;MediumId&apos;)) {
		return this._checkToken().then(() =&gt; {
			return this._tlsRequest(&apos;card/&apos;, {mediumId});
		});
	}
}

module.exports = OVApi;</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
